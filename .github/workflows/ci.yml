name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  build:
    name: Build & Verify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_API: ${{ secrets.TURBO_API }}
          TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
          TURBO_REMOTE_CACHE_SIGNATURE_KEY: ${{ secrets.TURBO_REMOTE_CACHE_SIGNATURE_KEY }}

      - name: Verify CI Gate
        run: |
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "::group::Attempt $attempt of $max_attempts"
            set +e
            bun run verify:ci 2>&1 | tee /tmp/verify-ci-output.log
            exit_code=${PIPESTATUS[0]}
            set -e
            echo "::endgroup::"

            if [ $exit_code -eq 0 ]; then
              exit 0
            fi

            # Only retry on OOM: exit code 137 directly, or logged in output
            # (the orchestrator wraps 137 into exit code 1, so check output too)
            is_oom=false
            if [ $exit_code -eq 137 ]; then
              is_oom=true
            elif grep -q 'exited (137)\|exitCode=137\|exit code 137' /tmp/verify-ci-output.log 2>/dev/null; then
              is_oom=true
            fi

            if [ "$is_oom" = false ]; then
              echo "::error::verify:ci failed with exit code $exit_code"
              exit $exit_code
            fi

            if [ $attempt -eq $max_attempts ]; then
              echo "::error::OOM (exit 137) persisted after $max_attempts attempts"
              exit 1
            fi

            echo "::warning::OOM detected (exit 137), retrying (attempt $((attempt + 1)) of $max_attempts)..."
            attempt=$((attempt + 1))
          done
        env:
          NO_CHANGESET: ${{ contains(github.event.pull_request.labels.*.name, 'release:none') && '1' || '0' }}
          OUTFITTER_CI_TURBO_CONCURRENCY: "2"
          OUTFITTER_CI_BUN_MAX_CONCURRENCY: "4"
          OUTFITTER_CI_TURBO_LOG_ORDER: "stream"
          OUTFITTER_CI_TURBO_OUTPUT_LOGS: "errors-only"
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_API: ${{ secrets.TURBO_API }}
          TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
          TURBO_REMOTE_CACHE_SIGNATURE_KEY: ${{ secrets.TURBO_REMOTE_CACHE_SIGNATURE_KEY }}

      - name: Upload test diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-test-diagnostics-${{ github.run_id }}-${{ github.run_attempt }}
          if-no-files-found: ignore
          path: |
            .outfitter/reports/ci/**
            .turbo/runs/*.json
